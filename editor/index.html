<!DOCTYPE html>
<html lang="en">
<head>
    <title>Scribe editor</title>

    <meta charset="utf-8" />
    <meta name="author" content="@stephband" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width" />

    <script title="load">
        document.documentElement.className += ' js loading';
        // window.addEventListener('DOMContentLoaded', () => document.documentElement.classList.remove('content-loading'));
        // Wait for other load handlers to run first - Bolt does a few things on
        // load (eg. targetable scrolls) and we want them to run before the loading
        // class is removed
        window.addEventListener('load', () => window.requestAnimationFrame(() => document.documentElement.classList.remove('loading')));
        window.DEBUG = true;
    </script>

    <link rel="stylesheet" href="../module.css">
    <link rel="stylesheet" href="./module.css">

    <style>
        html {
            padding: 0;
        }

        body {
            padding: 0.5em;
        }

        body > .scribe {
            margin-left: calc(-1 * var(--bar-padding-left));
            margin-right: calc(-1 * var(--bar-padding-left));
        }

        .scribe {
            -webkit-user-select: none; /* Safari */
                -ms-user-select: none; /* IE 10 and IE 11 */
                    user-select: none; /* Standard syntax */
        }

        .scribe > .bar {
            flex: 1 1 100%;
        }

        @media (min-width: 30em) {
            .scribe > .bar {
                flex: 1 1 50%;
            }
        }

        @media (min-width: 45em) {
            .scribe > .bar {
                flex: 1 1 33.3333333%;
            }
        }

        @media (min-width: 60em) {
            .scribe > .bar {
                flex: 1 1 25%;
            }
        }

        @media (min-width: 90em) {
            .scribe > .bar {
                flex: 1 1 16.666666667%;
            }
        }

        @media (min-width: 120em) {
            .scribe > .bar {
                flex: 1 1 12.5%;
            }
        }

        .scribe::after {
            content: '';
            flex: 6 1;
        }

        footer {
            margin-top: 2em;
        }

        footer > textarea {
            display: block;
            width: 100%;
            resize: auto;
            padding: 0;
            background: #eeeeee;
            border-width: 0;
        }
    </style>

    <script type="module">
        import overload from '../../fn/modules/overload.js';
        import events   from '../../dom/modules/events.js';
        import { sequence, changeZoneDuration, highlightZones, unhighlightZones, unhighlightSymbols } from './module.js';
        import { clear } from './modules/selection.js';


        // Add SVG symbol definitions to the body
        import create  from '../../dom/modules/create.js';
        import svgdefs from '../modules/svgdefs.js';

        const fragment = create('fragment', svgdefs);
        document.body.append(fragment);

        // Flag Safari
        const isSafari = navigator.userAgent.includes('AppleWebKit/')
            && !navigator.userAgent.includes('Chrome/')
            && !navigator.userAgent.includes('Edge/')
            && !navigator.userAgent.includes('Gecko/');

        if (isSafari) {
            document.body.classList.add('safari');
        }

        // Make inputs size of their placeholders
        document.querySelectorAll('input').forEach((input) => {
            input.size = input.value ? input.value.length : input.placeholder.length || 6;
        });

        // Make inputs auto-expand to size of value or placeholder or 6
        events({ type: 'input', select: 'input' }, document.body)
        .each((e) => (e.target.size =
            e.target.value ? e.target.value.length :
            e.target.placeholder ? e.target.placeholder.length :
            6
        ));

        // Update sequence from inputs
        events({ type: 'input', select: 'input' }, document.body)
        .each(overload((e) => e.target.name, {
            'name':      (e) => sequence.name = e.target.value,
            'author':    (e) => sequence.author ?
                (sequence.author.name = e.target.value) :
                (sequence.author = { name: e.target.value }),
            'arranger':  (e) => sequence.arranger = e.target.value,
            'zone-duration': (e) => {
                changeZoneDuration(Number(e.target.value));
                highlightZones();
            },
            'edit-mode': (e) => {
                if (e.target.checked) {
                    document.body.classList.add('edit');
                }
                else {
                    document.body.classList.remove('edit');
                    clear();
                    unhighlightZones();
                    unhighlightSymbols();
                }
            },
            default:     (e) => console.log('name="' + e.target.name + '" not handled')
        }));

        events({ type: 'click', select: 'button' }, document.body)
        .each(overload((e) => e.target.name, {
            'export': (e) => {
                console.log(sequence);
                document.getElementById('json').value = JSON.stringify(sequence);
            }
        }));
    </script>
</head>
<body>
    <header class="header">
        <input class="title" type="text" name="name" value="" placeholder="Song Title" />
        <input class="credit" type="text" name="author" value="" placeholder="Author" />
        <input class="part" type="text" name="part" value="" placeholder="Part" />
    </header>

    <main class="scribe" id="scribe-bars">

    </main>

    <footer>
        <hr/>

        <input type="radio" name="zone-duration" value="0.166666667" id="zone-duration-triplet16th" />
        <label for="zone-duration-triplet16th">triplet 16th</label>
        <input type="radio" name="zone-duration" value="0.25" id="zone-duration-16th" />
        <label for="zone-duration-16th">16th</label>
        <input type="radio" name="zone-duration" value="0.333333333" id="zone-duration-triplet8th" />
        <label for="zone-duration-triplet8th">triplet 8th</label>
        <input type="radio" name="zone-duration" value="0.5" id="zone-duration-8th" checked />
        <label for="zone-duration-8th">8th</label>
        <input type="radio" name="zone-duration" value="0.666666667" id="zone-duration-triplet" />
        <label for="zone-duration-triplet">triplet</label>
        <input type="radio" name="zone-duration" value="1" id="zone-duration-quarter" />
        <label for="zone-duration-quarter">quarter</label>

        <hr/>

        <input type="checkbox" name="edit-mode" id="edit-mode" checked />
        <label for="edit-mode">Edit mode</label>

        <hr/>

        <button class="button" name="export" value="">Export</button>
        <textarea readonly id="json"></textarea>
    </footer>
</body>
</html>
